## Redis主从

#### 架构简略图

<img src="https://images2018.cnblogs.com/blog/907596/201807/907596-20180710175627988-299575978.png" alt="img" style="zoom:50%;" />

​		其中每个节点，如果他有子节点，那么相当于其也是一个master。

​		主节点一般情况下只负责写入数据，从节点从主节点同步数据，只负责读取。

​		当主节点因为某些原因挂掉后，选举新的从节点来作为新的主节点。新的主节点只有在被手动设置为主节点后才可以具备写入权限。

#### Redis主从同步

![img](https://img2018.cnblogs.com/blog/962833/201810/962833-20181031110448020-150004929.png)

#### 全量同步

**过程**

​		同步快照阶段，主服务器生成快照，并且将生成快照期间的**写**命令存入缓存区

​		将快照文件发送至从服务器，从服务器解析并执行快照，此阶段的所有写命令也将存入缓冲区。

​		最后同步master的写缓冲，开启增量同步阶段

**步骤**

|                            Master                            |                        Slave                         |
| :----------------------------------------------------------: | :--------------------------------------------------: |
|                              -                               |              连接至master，发送SYNC命令              |
| 执行BGSAVE，并使用缓冲区记录此后所有写命令，配置文件中的**stop-writes-on-bgsave-error**可以控制此时是否能接受写命令 | 根据配置选择是否用旧数据接受客户端请求，或者直接报错 |
|          向Slave发送快照文件，继续缓冲此期间的命令           |             丢弃所有旧数据，执行快照文件             |
|                        发送缓冲区命令                        |                  开始执行缓冲区命令                  |
|     以上完成后每执行一个写命令，向Slave发送相同的写命令      |               执行每个Master发来的命令               |

​		当有新的Slave来的时候，如果Master还未发送快照文件，那么就不需要其他操作。如果Master发送了快照文件，那么就等当前同步完成后，再执行一遍。

#### 增量同步

​		当Master和Slave同步过后，Master每执行一条写命令，都会向Slave发送相同的命令。